---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install base packages
  ansible.builtin.apt:
    name:
      - git
      - curl
      - build-essential
      - ufw
      - nginx
      - python3-pip
    state: present

- name: Install Node.js repo
  ansible.builtin.shell: |
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  args:
    creates: /etc/apt/sources.list.d/nodesource.list

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present

- name: Create application group
  ansible.builtin.group:
    name: "{{ app_group }}"
    system: true

- name: Create application user
  ansible.builtin.user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    system: true
    create_home: true
    home: /home/{{ app_user }}
    shell: /bin/bash

- name: Create deploy root
  ansible.builtin.file:
    path: "{{ deploy_root }}"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    state: directory
    mode: "0755"

- name: Allow firewall ports
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "22"
    - "80"
    - "443"
    - "{{ backend_port }}"

- name: Enable firewall
  community.general.ufw:
    state: enabled
    logging: on

- name: Ensure nginx enabled
  ansible.builtin.service:
    name: nginx
    enabled: true
    state: started

